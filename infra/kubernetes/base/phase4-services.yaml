# ── ARGUS Phase 4 Services: Evacuation RL, MIRROR,
#    ScarNet, Model Monitor ─────────────────────────────────────
---
# ═══════════════════════════════════════════════════════════════
# Evacuation RL Agent (port 8010)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-evacuation-rl
  namespace: argus-prod
  labels:
    app: argus-evacuation-rl
    tier: ai-core
    phase: "4"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-evacuation-rl
  template:
    metadata:
      labels:
        app: argus-evacuation-rl
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8010"
    spec:
      containers:
        - name: evacuation-rl
          image: argus/evacuation-rl:3.0
          ports:
            - containerPort: 8010
          resources:
            requests:
              memory: "512Mi"
              cpu: "300m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: redis_url
            - name: DQN_MODEL_PATH
              value: "/models/dqn_evacuation.pt"
            - name: DEMO_MODE
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8010
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-evacuation-rl
  namespace: argus-prod
spec:
  selector:
    app: argus-evacuation-rl
  ports:
    - port: 8010
      targetPort: 8010
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-evacuation-rl-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-evacuation-rl
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
---
# ═══════════════════════════════════════════════════════════════
# MIRROR Digital Twin (port 8011)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-mirror
  namespace: argus-prod
  labels:
    app: argus-mirror
    tier: simulation
    phase: "4"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: argus-mirror
  template:
    metadata:
      labels:
        app: argus-mirror
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8011"
    spec:
      containers:
        - name: mirror
          image: argus/mirror:3.0
          ports:
            - containerPort: 8011
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "2000m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: redis_url
            - name: SCARNET_DEMO_MODE
              value: "true"
            - name: NASA_EARTHDATA_TOKEN
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: nasa_earthdata_token
            - name: SIMULATION_TIMESTEP
              value: "900"
            - name: DEMO_MODE
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8011
            initialDelaySeconds: 45
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /health
              port: 8011
            initialDelaySeconds: 20
            periodSeconds: 10
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-mirror
  namespace: argus-prod
spec:
  selector:
    app: argus-mirror
  ports:
    - port: 8011
      targetPort: 8011
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-mirror-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-mirror
  minReplicas: 1
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75
---
# ═══════════════════════════════════════════════════════════════
# ScarNet Post-Disaster Assessment (port 8012)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-scarnet
  namespace: argus-prod
  labels:
    app: argus-scarnet
    tier: ai-core
    phase: "4"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: argus-scarnet
  template:
    metadata:
      labels:
        app: argus-scarnet
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8012"
    spec:
      containers:
        - name: scarnet
          image: argus/scarnet:3.0
          ports:
            - containerPort: 8012
          resources:
            requests:
              memory: "512Mi"
              cpu: "300m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: SCARNET_DEMO_MODE
              value: "true"
            - name: NASA_EARTHDATA_TOKEN
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: nasa_earthdata_token
            - name: SENTINEL_AWS_BUCKET
              value: "sentinel-s2-l2a"
            - name: SCARNET_MODEL_PATH
              value: "/models/scarnet_unet.pt"
            - name: DEMO_MODE
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8012
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8012
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-scarnet
  namespace: argus-prod
spec:
  selector:
    app: argus-scarnet
  ports:
    - port: 8012
      targetPort: 8012
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-scarnet-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-scarnet
  minReplicas: 1
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75
---
# ═══════════════════════════════════════════════════════════════
# Model Monitor (port 8013)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-model-monitor
  namespace: argus-prod
  labels:
    app: argus-model-monitor
    tier: observability
    phase: "4"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: argus-model-monitor
  template:
    metadata:
      labels:
        app: argus-model-monitor
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8013"
    spec:
      containers:
        - name: model-monitor
          image: argus/model-monitor:3.0
          ports:
            - containerPort: 8013
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: redis_url
            - name: DRIFT_THRESHOLD
              value: "0.15"
            - name: MONITORING_INTERVAL
              value: "300"
            - name: DEMO_MODE
              value: "false"
          livenessProbe:
            httpGet:
              path: /health
              port: 8013
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8013
            initialDelaySeconds: 10
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: argus-model-monitor
  namespace: argus-prod
spec:
  selector:
    app: argus-model-monitor
  ports:
    - port: 8013
      targetPort: 8013
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-model-monitor-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-model-monitor
  minReplicas: 1
  maxReplicas: 3
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
