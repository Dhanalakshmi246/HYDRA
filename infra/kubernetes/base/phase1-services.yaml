# ── ARGUS Phase 1 Services: Ingestion, CV Gauging, Feature Engine,
#    Prediction, Alert Dispatcher ─────────────────────────────────────
---
# ═══════════════════════════════════════════════════════════════
# Ingestion (port 8001)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-ingestion
  namespace: argus-prod
  labels:
    app: argus-ingestion
    tier: data-pipeline
    phase: "1"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-ingestion
  template:
    metadata:
      labels:
        app: argus-ingestion
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8001"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: ingestion
          image: argus/ingestion:3.0
          ports:
            - containerPort: 8001
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: DEMO_MODE
              value: "false"
            - name: CWC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: cwc_api_key
            - name: IMD_API_KEY
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: imd_api_key
          livenessProbe:
            httpGet:
              path: /health
              port: 8001
            initialDelaySeconds: 15
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8001
            initialDelaySeconds: 5
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: argus-ingestion
  namespace: argus-prod
spec:
  selector:
    app: argus-ingestion
  ports:
    - port: 8001
      targetPort: 8001
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-ingestion-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-ingestion
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
---
# ═══════════════════════════════════════════════════════════════
# CV Gauging (port 8002)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-cv-gauging
  namespace: argus-prod
  labels:
    app: argus-cv-gauging
    tier: computer-vision
    phase: "1"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-cv-gauging
  template:
    metadata:
      labels:
        app: argus-cv-gauging
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8002"
    spec:
      containers:
        - name: cv-gauging
          image: argus/cv-gauging:3.0
          ports:
            - containerPort: 8002
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1500m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: DEMO_MODE
              value: "false"
            - name: YOLO_MODEL_PATH
              value: "/models/yolo11n.pt"
            - name: SAM_MODEL_PATH
              value: "/models/sam2_tiny.pt"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8002
            initialDelaySeconds: 15
            periodSeconds: 5
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-cv-gauging
  namespace: argus-prod
spec:
  selector:
    app: argus-cv-gauging
  ports:
    - port: 8002
      targetPort: 8002
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-cv-gauging-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-cv-gauging
  minReplicas: 2
  maxReplicas: 8
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 75
---
# ═══════════════════════════════════════════════════════════════
# Feature Engine (port 8003)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-feature-engine
  namespace: argus-prod
  labels:
    app: argus-feature-engine
    tier: ai-core
    phase: "1"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-feature-engine
  template:
    metadata:
      labels:
        app: argus-feature-engine
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8003"
    spec:
      containers:
        - name: feature-engine
          image: argus/feature-engine:3.0
          ports:
            - containerPort: 8003
          resources:
            requests:
              memory: "512Mi"
              cpu: "300m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: TIMESCALEDB_DSN
              value: "postgresql://argus:$(TIMESCALE_PASSWORD)@$(TIMESCALE_HOST):5432/argus_db"
            - name: TIMESCALE_HOST
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: timescale_host
            - name: TIMESCALE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: timescale_password
            - name: PINN_CHECKPOINT_PATH
              value: "/models/pinn_beas_river.pt"
            - name: DEMO_MODE
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8003
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8003
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-feature-engine
  namespace: argus-prod
spec:
  selector:
    app: argus-feature-engine
  ports:
    - port: 8003
      targetPort: 8003
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-feature-engine-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-feature-engine
  minReplicas: 2
  maxReplicas: 12
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: External
      external:
        metric:
          name: kafka_consumer_lag
          selector:
            matchLabels:
              topic: gauge.realtime
        target:
          type: AverageValue
          averageValue: "200"
---
# ═══════════════════════════════════════════════════════════════
# Prediction Engine (port 8004)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-prediction
  namespace: argus-prod
  labels:
    app: argus-prediction
    tier: ai-core
    phase: "1"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-prediction
  template:
    metadata:
      labels:
        app: argus-prediction
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8004"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: prediction
          image: argus/prediction:3.0
          ports:
            - containerPort: 8004
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: redis_url
            - name: XGBOOST_MODEL_PATH
              value: "/models/xgboost_flood.joblib"
            - name: TFT_CHECKPOINT_PATH
              value: "/models/tft_brahmaputra.ckpt"
            - name: TFT_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: tft_enabled
            - name: DEMO_MODE
              value: "false"
            - name: TRAIN_ON_STARTUP
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8004
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8004
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-prediction
  namespace: argus-prod
spec:
  selector:
    app: argus-prediction
  ports:
    - port: 8004
      targetPort: 8004
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-prediction-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-prediction
  minReplicas: 2
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: External
      external:
        metric:
          name: kafka_consumer_lag
          selector:
            matchLabels:
              topic: feature.engineered
        target:
          type: AverageValue
          averageValue: "100"
---
# ═══════════════════════════════════════════════════════════════
# Alert Dispatcher (port 8005)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-alert-dispatcher
  namespace: argus-prod
  labels:
    app: argus-alert-dispatcher
    tier: alerting
    phase: "1"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-alert-dispatcher
  template:
    metadata:
      labels:
        app: argus-alert-dispatcher
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8005"
    spec:
      containers:
        - name: alert-dispatcher
          image: argus/alert-dispatcher:3.0
          ports:
            - containerPort: 8005
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: DEMO_MODE
              value: "false"
            - name: TWILIO_ACCOUNT_SID
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: twilio_account_sid
            - name: TWILIO_AUTH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: twilio_auth_token
            - name: TWILIO_WHATSAPP_NUMBER
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: twilio_whatsapp_number
          livenessProbe:
            httpGet:
              path: /health
              port: 8005
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8005
            initialDelaySeconds: 5
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: argus-alert-dispatcher
  namespace: argus-prod
spec:
  selector:
    app: argus-alert-dispatcher
  ports:
    - port: 8005
      targetPort: 8005
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-alert-dispatcher-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-alert-dispatcher
  minReplicas: 2
  maxReplicas: 15
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
