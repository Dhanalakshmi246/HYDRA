# ── ARGUS Phase 2 Services: Causal Engine, FloodLedger ─────────────
---
# ═══════════════════════════════════════════════════════════════
# Causal Engine (port 8006) — GPU-enabled
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-causal-engine
  namespace: argus-prod
  labels:
    app: argus-causal-engine
    tier: ai-core
    phase: "2"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: argus-causal-engine
  template:
    metadata:
      labels:
        app: argus-causal-engine
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8006"
    spec:
      nodeSelector:
        eks.amazonaws.com/nodegroup: gpu
      tolerations:
        - key: "nvidia.com/gpu"
          operator: "Exists"
          effect: "NoSchedule"
      containers:
        - name: causal-engine
          image: argus/causal-engine:3.0
          ports:
            - containerPort: 8006
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
              nvidia.com/gpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2000m"
              nvidia.com/gpu: "1"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: TIMESCALEDB_DSN
              value: "postgresql://argus:$(TIMESCALE_PASSWORD)@$(TIMESCALE_HOST):5432/argus_db"
            - name: TIMESCALE_HOST
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: timescale_host
            - name: TIMESCALE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: timescale_password
            - name: BRAHMAPUTRA_DAG_PATH
              value: "/data/brahmaputra_dag.json"
            - name: DEMO_MODE
              value: "false"
          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
          livenessProbe:
            httpGet:
              path: /health
              port: 8006
            initialDelaySeconds: 60
            periodSeconds: 15
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8006
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: argus-models-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: argus-causal-engine
  namespace: argus-prod
spec:
  selector:
    app: argus-causal-engine
  ports:
    - port: 8006
      targetPort: 8006
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-causal-engine-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-causal-engine
  minReplicas: 1
  maxReplicas: 4
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
---
# ═══════════════════════════════════════════════════════════════
# FloodLedger Blockchain (port 8007)
# ═══════════════════════════════════════════════════════════════
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argus-flood-ledger
  namespace: argus-prod
  labels:
    app: argus-flood-ledger
    tier: blockchain
    phase: "2"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: argus-flood-ledger
  template:
    metadata:
      labels:
        app: argus-flood-ledger
        version: "3.0"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8007"
    spec:
      containers:
        - name: flood-ledger
          image: argus/flood-ledger:3.0
          ports:
            - containerPort: 8007
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              valueFrom:
                configMapKeyRef:
                  name: argus-config
                  key: kafka_bootstrap_servers
            - name: HARDHAT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: argus-secrets
                  key: hardhat_private_key
            - name: POLYGON_RPC_URL
              value: "https://polygon-amoy.g.alchemy.com/v2/demo"
            - name: DEMO_MODE
              value: "false"
          livenessProbe:
            httpGet:
              path: /health
              port: 8007
            initialDelaySeconds: 15
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8007
            initialDelaySeconds: 10
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: argus-flood-ledger
  namespace: argus-prod
spec:
  selector:
    app: argus-flood-ledger
  ports:
    - port: 8007
      targetPort: 8007
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: argus-flood-ledger-hpa
  namespace: argus-prod
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: argus-flood-ledger
  minReplicas: 2
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
